const SVG_string = {
  "close-line":
    '<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="122.878px" height="122.88px" viewBox="0 0 122.878 122.88" enable-background="new 0 0 122.878 122.88" xml:space="preserve"><g><path d="M1.426,8.313c-1.901-1.901-1.901-4.984,0-6.886c1.901-1.902,4.984-1.902,6.886,0l53.127,53.127l53.127-53.127 c1.901-1.902,4.984-1.902,6.887,0c1.901,1.901,1.901,4.985,0,6.886L68.324,61.439l53.128,53.128c1.901,1.901,1.901,4.984,0,6.886 c-1.902,1.902-4.985,1.902-6.887,0L61.438,68.326L8.312,121.453c-1.901,1.902-4.984,1.902-6.886,0 c-1.901-1.901-1.901-4.984,0-6.886l53.127-53.128L1.426,8.313L1.426,8.313z"/></g></svg>',
  "filter-line":
    '<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="122.88px" height="107.128px" viewBox="0 0 122.88 107.128" enable-background="new 0 0 122.88 107.128" xml:space="preserve"><g><path d="M2.788,0h117.297c1.544,0,2.795,1.251,2.795,2.795c0,0.85-0.379,1.611-0.978,2.124l-46.82,46.586v39.979 c0,1.107-0.643,2.063-1.576,2.516l-22.086,12.752c-1.333,0.771-3.039,0.316-3.812-1.016c-0.255-0.441-0.376-0.922-0.375-1.398 h-0.006V51.496L0.811,4.761C-0.275,3.669-0.27,1.904,0.822,0.819c0.544-0.541,1.255-0.811,1.966-0.811V0L2.788,0z M113.323,5.591 H9.493L51.851,48.24c0.592,0.512,0.966,1.27,0.966,2.114v49.149l16.674-9.625V50.354h0.008c0-0.716,0.274-1.432,0.822-1.977 L113.323,5.591L113.323,5.591z"/></g></svg>',
  "search-line":
    '<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="119.828px" height="122.88px" viewBox="0 0 119.828 122.88" enable-background="new 0 0 119.828 122.88" xml:space="preserve"><g><path d="M48.319,0C61.662,0,73.74,5.408,82.484,14.152c8.744,8.744,14.152,20.823,14.152,34.166 c0,12.809-4.984,24.451-13.117,33.098c0.148,0.109,0.291,0.23,0.426,0.364l34.785,34.737c1.457,1.449,1.465,3.807,0.014,5.265 c-1.449,1.458-3.807,1.464-5.264,0.015L78.695,87.06c-0.221-0.22-0.408-0.46-0.563-0.715c-8.213,6.447-18.564,10.292-29.814,10.292 c-13.343,0-25.423-5.408-34.167-14.152C5.408,73.741,0,61.661,0,48.318s5.408-25.422,14.152-34.166C22.896,5.409,34.976,0,48.319,0 L48.319,0z M77.082,19.555c-7.361-7.361-17.53-11.914-28.763-11.914c-11.233,0-21.403,4.553-28.764,11.914 C12.194,26.916,7.641,37.085,7.641,48.318c0,11.233,4.553,21.403,11.914,28.764c7.36,7.361,17.53,11.914,28.764,11.914 c11.233,0,21.402-4.553,28.763-11.914c7.361-7.36,11.914-17.53,11.914-28.764C88.996,37.085,84.443,26.916,77.082,19.555 L77.082,19.555z"/></g></svg>',
  "double-arrow":
    '<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="0 0 120.64 122.88" style="enable-background:new 0 0 120.64 122.88" xml:space="preserve"><g><path d="M54.03,108.91c-1.55,1.63-2.31,3.74-2.28,5.85c0.03,2.11,0.84,4.2,2.44,5.79l0.12,0.12c1.58,1.5,3.6,2.23,5.61,2.2 c2.01-0.03,4.01-0.82,5.55-2.37c17.66-17.66,35.13-35.61,52.68-53.4c0.07-0.05,0.13-0.1,0.19-0.16c1.55-1.63,2.31-3.76,2.28-5.87 c-0.03-2.11-0.85-4.21-2.45-5.8l-0.27-0.26C100.43,37.47,82.98,19.87,65.46,2.36C63.93,0.82,61.93,0.03,59.92,0 c-2.01-0.03-4.03,0.7-5.61,2.21l-0.15,0.15c-1.57,1.58-2.38,3.66-2.41,5.76c-0.03,2.1,0.73,4.22,2.28,5.85l47.22,47.27 L54.03,108.91L54.03,108.91z M2.26,106.91c-1.54,1.62-2.29,3.73-2.26,5.83c0.03,2.11,0.84,4.2,2.44,5.79l0.12,0.12 c1.57,1.5,3.6,2.23,5.61,2.21c2.01-0.03,4.02-0.82,5.55-2.37C31.01,101.2,48.87,84.2,66.39,67.12c0.07-0.05,0.14-0.11,0.21-0.17 c1.55-1.63,2.31-3.76,2.28-5.87c-0.03-2.11-0.85-4.21-2.45-5.8C48.94,38.33,31.36,21.44,13.83,4.51l-0.12-0.13 c-1.53-1.54-3.53-2.32-5.54-2.35C6.16,2,4.14,2.73,2.56,4.23L2.41,4.38C0.84,5.96,0.03,8.05,0,10.14c-0.03,2.1,0.73,4.22,2.28,5.85 l47.18,45.24L2.26,106.91L2.26,106.91z"/></g></svg>',
  reset:
    '<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="110.379px" height="122.879px" viewBox="0 0 110.379 122.879" enable-background="new 0 0 110.379 122.879" xml:space="preserve"><g><path d="M41.759,15.103l-0.003,0.174h35.077c0.089,0,0.176,0.005,0.262,0.016c3.325,0.267,6.487,0.843,9.461,1.78l0.008,0.003 c3.021,0.95,5.853,2.286,8.469,4.062c1.827,1.239,3.404,2.59,4.768,4.033c1.363,1.441,2.527,2.988,3.532,4.618 c1.557,2.527,2.806,5.523,3.803,8.643c1.228,3.84,2.076,7.868,2.65,11.415c0.229,1.417,0.398,2.801,0.449,4.005 c0.059,1.382-0.049,2.591-0.399,3.472c-0.206,0.519-0.473,0.962-0.801,1.326c-0.378,0.421-0.831,0.738-1.357,0.949 c-3.667,1.468-6.662-2.08-8.46-4.211l-0.004,0.003l-0.331-0.393c-3.032-3.536-6.757-6.041-11.022-7.732 c-4.333-1.718-9.252-2.611-14.598-2.903l-31.771,0.002l0.015,0.271l0,9.127c0,0.086-0.005,0.17-0.015,0.253 c-0.089,2.142-0.799,3.66-2.136,4.544c-1.34,0.887-3.091,0.97-5.257,0.24c-0.235-0.079-0.448-0.196-0.632-0.341 c-10.452-8.2-20.905-16.397-31.353-24.602l-0.147-0.127C0.23,32.152-0.25,30.51,0.114,28.867c0.322-1.452,1.333-2.69,2.692-3.761 l28.87-22.727c1.25-0.984,2.562-1.749,3.797-2.119c1.107-0.332,2.187-0.362,3.181-0.002c1.084,0.393,1.95,1.188,2.502,2.475 c0.393,0.917,0.615,2.098,0.615,3.584v8.556C41.772,14.951,41.768,15.028,41.759,15.103L41.759,15.103z M68.619,107.776 l0.003-0.175H33.545c-0.088,0-0.176-0.005-0.261-0.016c-3.325-0.267-6.488-0.843-9.461-1.78l-0.007-0.003 c-3.021-0.949-5.853-2.285-8.469-4.061c-1.839-1.248-3.423-2.607-4.791-4.059c-1.376-1.459-2.546-3.018-3.551-4.656 c-1.622-2.646-2.98-6.021-4.055-9.54c-1.276-4.181-2.157-8.56-2.607-12.145c-0.133-1.063-0.214-2.102-0.213-3.053 c0.001-1.071,0.125-2.011,0.414-2.735c0.202-0.506,0.467-0.945,0.798-1.314c0.385-0.43,0.838-0.751,1.36-0.961 c3.667-1.468,6.663,2.08,8.46,4.212l0.004-0.003l0.332,0.393c3.032,3.536,6.756,6.041,11.022,7.731 c4.333,1.718,9.252,2.611,14.598,2.903l31.77-0.003l-0.015-0.271l-0.001-9.127c0-0.086,0.006-0.17,0.016-0.253 c0.089-2.143,0.799-3.661,2.136-4.545c1.341-0.887,3.091-0.97,5.257-0.239c0.235,0.078,0.447,0.195,0.632,0.341l31.354,24.602 l0.147,0.127c1.736,1.58,2.217,3.224,1.853,4.865c-0.322,1.452-1.333,2.69-2.692,3.761L78.702,120.5 c-1.25,0.984-2.562,1.748-3.797,2.118c-1.107,0.332-2.187,0.362-3.182,0.003c-1.084-0.393-1.95-1.188-2.502-2.476 c-0.393-0.917-0.615-2.098-0.615-3.584v-8.556C68.606,107.928,68.611,107.852,68.619,107.776L68.619,107.776z M72.229,105.025 c0.465,0.773,0.603,1.688,0.592,2.831l0.006,0.149v8.556c0,0.904,0.097,1.535,0.269,1.936c0.051,0.118,0.057,0.165,0.063,0.167 c0.082,0.03,0.274-0.004,0.544-0.084c0.699-0.209,1.534-0.716,2.396-1.394l28.869-22.728c0.652-0.514,1.111-0.986,1.193-1.354 c0.034-0.157-0.121-0.416-0.555-0.815L74.6,67.956c-0.664-0.199-1.081-0.242-1.253-0.128c-0.146,0.097-0.233,0.486-0.259,1.165 l0.004,9.172c0.075,1.035-0.088,1.955-0.538,2.734c-0.531,0.924-1.354,1.532-2.516,1.771c-0.164,0.041-0.335,0.063-0.512,0.063 H37.117v-0.005l-0.107-0.003c-5.816-0.309-11.215-1.293-16.04-3.205c-4.89-1.938-9.166-4.817-12.66-8.889l-0.36-0.423l0.004-0.004 l-0.004-0.005c-0.996-1.181-2.616-3.102-3.517-3.049c-0.069,0.218-0.1,0.616-0.101,1.14c0,0.683,0.074,1.562,0.197,2.542 c0.428,3.417,1.255,7.547,2.442,11.435c0.975,3.191,2.191,6.228,3.626,8.568c0.854,1.394,1.851,2.721,3.023,3.964 c1.179,1.249,2.528,2.41,4.083,3.465c2.238,1.519,4.708,2.677,7.38,3.52c2.655,0.839,5.505,1.355,8.521,1.599h35.392v0.009 C70.569,103.392,71.57,103.931,72.229,105.025L72.229,105.025z M38.149,17.854c-0.466-0.772-0.604-1.688-0.592-2.831l-0.005-0.149 V6.317c0-0.904-0.098-1.535-0.269-1.936c-0.051-0.118-0.057-0.165-0.063-0.167c-0.083-0.03-0.274,0.004-0.544,0.084 c-0.699,0.21-1.535,0.716-2.396,1.394L5.411,28.419c-0.652,0.514-1.111,0.987-1.192,1.354c-0.035,0.158,0.121,0.416,0.555,0.815 c10.332,8.115,20.671,16.223,31.006,24.334c0.664,0.2,1.081,0.242,1.251,0.128c0.147-0.097,0.234-0.487,0.259-1.165l-0.003-9.172 c-0.075-1.036,0.088-1.956,0.538-2.735c0.532-0.924,1.355-1.532,2.515-1.771c0.164-0.041,0.335-0.063,0.513-0.063h32.409v0.005 l0.107,0.003c5.815,0.308,11.215,1.293,16.039,3.206c4.89,1.938,9.166,4.817,12.66,8.889l0.359,0.423l-0.004,0.003l0.004,0.004 c0.996,1.181,2.616,3.103,3.517,3.049c0.1-0.305,0.12-0.916,0.087-1.712c-0.043-1.017-0.193-2.237-0.4-3.511 c-0.547-3.382-1.351-7.204-2.502-10.805c-0.898-2.81-2.01-5.487-3.375-7.703c-0.851-1.381-1.846-2.7-3.02-3.942 c-1.173-1.24-2.516-2.393-4.06-3.44c-2.238-1.519-4.708-2.677-7.38-3.52c-2.655-0.839-5.505-1.355-8.521-1.599H41.382v-0.008 C39.809,19.487,38.809,18.949,38.149,17.854L38.149,17.854z"/></g></svg>',
};

/**
 * a modal confirmation instance universally used by any filter that needs it
 */
const _modal = new ConfirmationModal(
  () => {},
  () => {},
  ""
);

const mapPreviewInstance = new ModalMapPreview();

/**
 * the abstraction for a filter:
 * - create a node and attaches to a given parent node passed to the constructor
 * - renders a generic filter using the render method that draws nodes based on: name, key, options
 */
class Filter {
  constructor(props) {
    this.className = props.className || "";
    this.title = props.title;

    /** options of which items can be marked as selected*/
    this.availableOptions = props.availableOptions;

    /**
     * the state of the filter before was opened - helps with restoring to the last version when 'Cancel' is hit
     * is updated after each 'Apply' hit
     */
    this.stateBeforeOpen = JSON.parse(JSON.stringify(props.availableOptions));

    /** helps to fully restore the component as it was at the page load*/
    this.initialValues = JSON.parse(JSON.stringify(props.availableOptions));

    /** is usefull for identifying the filter and matching with the backend part */
    this.filterKey = props.filterKey;

    this.parentNode = props.parentNode;

    this.containerNode = null;
    this.previousNodeContainer = null;

    this.resetBtnString = `<div itemprop="reset-filter-btn" class="flex-all icon-c cursor-pointer position-absolute reset-filter">
                              ${SVG_string["reset"]}
                        </div>`;

    this.modal = _modal;

    this.appendContainer = () => {
      if (this.previousNodeContainer) {
        this.parentNode.replaceChild(
          this.containerNode,
          this.previousNodeContainer
        );
      } else {
        this.parentNode.appendChild(this.containerNode);
      }

      this.previousNodeContainer = this.containerNode;
    };

    this.unMount = () => {
      if (this.containerNode && this.containerNode.parentNode) {
        this.containerNode.parentNode.removeChild(this.containerNode);
      }
    };

    /**
     * this is expected to be overwritten - (should have a abstract method responsability )
     */
    this.render = () => {};

    this.restoreToPrevious = () => {
      this.availableOptions = JSON.parse(JSON.stringify(this.stateBeforeOpen));
      this.render();
    };

    /** restore to the page load state */
    this.reset = () => {
      this.availableOptions = JSON.parse(JSON.stringify(this.initialValues));
      this.render();
    };

    this.onResetClick = () => {
      this.reset();
    };

    /** attaches the reset button to the node  */
    this.resetBtnSetup = () => {
      if (this.containerNode) {
        const resetNode =
          this.containerNode.querySelector(`[itemprop="reset-filter-btn"]`);
        if (resetNode) {
          resetNode.addEventListener("click", this.onResetClick);
        }
      }
    };

    /** abstract */
    this.updateState = () => {};

    this.saveState = () => {
      this.updateState();
      this.stateBeforeOpen = JSON.parse(JSON.stringify(this.availableOptions));
    };
  }
}

/**
 * a filter that opens a popup with checkboxes
 * a filter that displays the selected options as a group of buttons representing the applied filters that can be removed via click
 */
class FilterGenericExpandable extends Filter {
  constructor(props) {
    super(props);
    /**
     *
     * @param {FilterGenericExpandable} filterGenericExpandable
     * @param item
     * @param index
     */
    this.removeFilterItem = (item, index) => {
      this.availableOptions = this.availableOptions.map((_item, _index) =>
        _item.key === item.key ? { ..._item, value: false } : _item
      );
      this.render();
    };

    this.onConfirmModal = (modal) => {
      /* update selected options and re-render */
      const results = modal.getCheckBoxResults();
      this.availableOptions = this.availableOptions.map((item) => ({
        ...item,
        value: results.some((_item) => _item.key === item.key && _item.value),
      }));

      this.render();
    };

    this.onCancel = (modal) => {};

    this.onModalOpen = () => {
      this.modal.title = "Select options";
      this.modal.onConfirm = this.onConfirmModal;
      this.modal.onCancel = this.onCancel;

      /** pass the list of available options marked with one is selected */
      this.modal.createCheckBoxGroups(this.availableOptions);
      this.modal.showModal();
    };

    this.render = () => {
      this.containerNode = stringToHTML(`            
                <div class="filter-item" >
                      <div class="filter-name">${this.title}: </div>
                      <div class="flex-start flex-wrap filter-sub-items" >
                           ${this.availableOptions.reduce(
                             (prevVal, currVal, index) => {
                               if (!currVal.value) {
                                 return prevVal;
                               }

                               return ` ${prevVal}
                                       <button class="btn-secondary -delete filter-item-applied">
                                          ${currVal.label} <span id="delete-item-filter-${this.filterKey}-${currVal.key}" class="btn-child-x">x</span>
                                      </button>`;
                             },
                             ""
                           )}
                           
                           ${
                             this.availableOptions.every((item) => !item.value)
                               ? "<p> Please select. </p>"
                               : ""
                           }
                           
                          <div id="expand-list-btn${
                            this.filterKey
                          }" class="flex-all icon-c cursor-pointer position-absolute arrow-expand-c">
                              ${SVG_string["double-arrow"]}
                          </div>
                          ${this.resetBtnString}
                      </div>
                  </div>
            `);

      this.appendContainer();

      this.parentNode
        .querySelector(`[id="expand-list-btn${this.filterKey}"]`)
        .addEventListener("click", (event) => {
          this.onModalOpen();
        });

      this.availableOptions.forEach((item, index) => {
        const elementNode = document.getElementById(
          `delete-item-filter-${this.filterKey}-${item.key}`
        );
        elementNode &&
          elementNode.addEventListener("click", (event) => {
            this.removeFilterItem(item, index);
          });
      });

      this.resetBtnSetup();
    };
  }
}

/**
 * a filter variant where each option can be selected via checkboxes
 */
class FilterCheckBox extends Filter {
  constructor(props) {
    super(props);

    this.itemsContainerNode = null;
    this.checkBoxes = [];

    this.render = () => {
      this.containerNode = stringToHTML(`            
                <div class="filter-item${this.className}">
                      <div class="filter-name">${this.title}: </div>
                      <div class="flex-start flex-wrap filter-sub-items" >                           
                           ${
                             this.availableOptions.every((item) => !item.value)
                               ? "<p> Please select. </p>"
                               : ""
                           }
                           ${this.resetBtnString}
                      </div>
                  </div>
            `);

      this.appendContainer();

      this.itemsContainerNode =
        this.containerNode.querySelector(`.filter-sub-items`);
      this.createCheckBoxGroups();
      this.resetBtnSetup();
    };

    this.createCheckBoxGroups = () => {
      this.itemsContainerNode.innerHTML = "";
      this.checkBoxes = this.availableOptions.map((item) => {
        return new CheckBoxItem({
          label: item.label,
          key: item.key,
          value: item.value,
          parentNode: this.itemsContainerNode,
        });
      });

      this.checkBoxes.forEach((item) => {
        item.render();
      });

      this.itemsContainerNode.appendChild(stringToHTML(this.resetBtnString));
      this.resetBtnSetup();
    };

    this.updateState = () => {
      this.checkBoxes.forEach((item) => {
        const result = item.getResult();
        const indexMatch = this.availableOptions.findIndex(
          (item) => item.key === result.key
        );

        if (indexMatch > -1) {
          this.availableOptions[indexMatch].value = result.value;
        }
      });
    };
  }
}

class FilterRange extends FilterCheckBox {
  constructor(props) {
    super(props);

    this.className += " range-input";

    this.createCheckBoxGroups = () => {
      this.itemsContainerNode.innerHTML = "";
      this.checkBoxes = this.availableOptions.map((item) => {
        return new RangeInput({
          label: item.label,
          key: item.key,
          value: item.value,
          min: item.min,
          max: item.max,
          parentNode: this.itemsContainerNode,
        });
      });

      this.checkBoxes.forEach((item) => {
        item.render();
      });

      this.itemsContainerNode.appendChild(stringToHTML(this.resetBtnString));
      this.resetBtnSetup();
    };
  }
}

class DateFilter extends FilterCheckBox {
  constructor(props) {
    super(props);

    this.createCheckBoxGroups = () => {
      this.itemsContainerNode.innerHTML = "";
      this.checkBoxes = this.availableOptions.map((item) => {
        return new DateInput({
          label: item.label,
          key: item.key,
          value: item.value,
          parentNode: this.itemsContainerNode,
        });
      });

      this.checkBoxes.forEach((item) => {
        item.render();
      });

      this.itemsContainerNode.appendChild(stringToHTML(this.resetBtnString));
      this.resetBtnSetup();
    };
  }
}

class LocationFilter extends FilterGenericExpandable {
  constructor(props) {
    super(props);

    this.onConfirmModal = (modal) => {
      /* update selected options and re-render */
      const { lat, lon } = modal.getMapResults();

      if (isNaN(lat) || isNaN(lon)) {
        this.availableOptions[0].value = "";
        this.availableOptions[1].value = "";
      } else {
        this.availableOptions[0].value = lat;
        this.availableOptions[1].value = lon;
      }

      this.render();
    };

    this.onCancel = (modal) => {};

    this.onModalOpen = () => {
      this.modal.title =
        "Pin a location around your results that you want to filter (by clicking the map). The points are colored based on serverity.";
      this.modal.onConfirm = this.onConfirmModal;
      this.modal.onCancel = this.onCancel;

      /** pass the list of available options marked with one is selected */
      let lat = this.availableOptions[0].value;
      let lon = this.availableOptions[1].value;

      this.modal.createMapLocation(lat, lon);
      this.modal.showModal();
    };

    this.render = () => {
      this.containerNode = stringToHTML(`            
                <div class="filter-item" >
                      <div class="filter-name" >${this.title}: </div>
                      <div class="flex-start flex-wrap filter-sub-items" >
                           
                           
                           ${
                             this.availableOptions.some(
                               (item) => isNaN(item.value) || item.value === ""
                             )
                               ? "<p> Please select. </p>"
                               : `<p>Lat ${this.availableOptions[0].value}, Long ${this.availableOptions[1].value}</p>`
                           }
                           
                          <div id="expand-list-btn${
                            this.filterKey
                          }" class="flex-all icon-c cursor-pointer position-absolute arrow-expand-c">
                              ${SVG_string["double-arrow"]}
                          </div>
                          ${this.resetBtnString}
                      </div>
                  </div>
            `);

      this.appendContainer();

      this.parentNode
        .querySelector(`[id="expand-list-btn${this.filterKey}"]`)
        .addEventListener("click", (event) => {
          this.onModalOpen();
        });

      this.resetBtnSetup();
    };
  }
}

class SearchInput {
  constructor(props) {
    this.selectors = {
      searchContainerSelector: `#search-results`,
      searchInputSelector: `input`,
      filterToggleSelector: `[itemprop="filter-btn"]`,
      clearInputSelector: `[itemprop="delete-btn"]`,
      searchBtnSelector: `[itemprop="search-btn"]`,
      exportBtnSelector: `#export-btn`,
    };

    this.lastSearchValue = "";

    this.filterContainerNode = props.filterContainerNode;

    this.containerNode = document.querySelector(
      this.selectors.searchContainerSelector
    );
    this.filterToggleNode = this.containerNode.querySelector(
      this.selectors.filterToggleSelector
    );
    this.searchInputNode = this.containerNode.querySelector(
      this.selectors.searchInputSelector
    );
    this.clearInputNode = this.containerNode.querySelector(
      this.selectors.clearInputSelector
    );
    this.searchBtnNode = this.containerNode.querySelector(
      this.selectors.searchBtnSelector
    );

    this.exportBtnNode = document.querySelector(
      this.selectors.exportBtnSelector
    );

    this.toggleOpen = false;

    this.setFilterActive = (value) => {
      this.toggleOpen = value;

      if (this.toggleOpen) {
        this.filterContainerNode.style.maxHeight = "3000px";
      } else {
        this.filterContainerNode.style.maxHeight = "0px";
      }
      this.filterToggleNode.classList.add("active-"+String(Boolean(this.toggleOpen)));
      this.filterToggleNode.classList.remove("active-"+String(!Boolean(this.toggleOpen)));
    };

    this.setFilterActive(false);

    this.filterToggleNode.addEventListener("click", (event) => {
      this.setFilterActive(!this.toggleOpen);
    });

    this.searchBtnNode.addEventListener("click", () => {
      if (typeof this.fetchListCallback === "function") {
        this.fetchListCallback();
      }
    });

    this.getValue = () => {
      return this.searchInputNode.value;
    };

    this.valuesAreFetching = (value) => {
      this.searchBtnNode.disabled = Boolean(value);
      this.searchInputNode.disabled = Boolean(value);
      this.filterToggleNode.disabled = Boolean(value);
      this.clearInputNode.disabled = Boolean(value);
    };

    this.setFiltersFetching = (value) => {
      this.valuesAreFetching(value);
    };

    this.listIsFetching = (value) => {
      this.valuesAreFetching(value);
    };
  }
}

class SearchResult {
  constructor(props) {
    this.subjectPrepare = (subject) => {
      subject.location = `${subject.lat} lat, ${subject.long} long`;
      return subject;
    };

    this.subject = this.subjectPrepare(props.subject);
    this.containerNode = props.containerNode;

    this.mapping = [
      /** general info */
      { selector: `[itemprop="item-date"]`, property: `date` },
      { selector: `[itemprop="item-severity"]`, property: `severity` },
      { selector: `[itemprop="item-id"]`, property: `id` },
      { selector: `[itemprop="item-city"]`, property: `address.city` },
      { selector: `[itemprop="item-state"]`, property: `address.state` },
      { selector: `[itemprop="item-description"]`, property: `description` },
      { selector: `[itemprop="item-location"]`, property: `location` },

      /** weather stats */
      {
        selector: `[itemprop="item-weather-condition"]`,
        property: `weather.generalCondition`,
      },
      { selector: `[itemprop="item-temperature"]`, property: `weather.temperature` },
      { selector: `[itemprop="item-humidity"]`, property: `weather.humidity` },
      { selector: `[itemprop="item-visibility"]`, property: `weather.visibility` },
      { selector: `[itemprop="item-wind-direction"]`, property: `weather.windDirection` },
      { selector: `[itemprop="item-wind-speed"]`, property: `weather.windSpeed` },
      { selector: `[itemprop="item-wind-windChill"]`, property: `weather.windChill` },
      { selector: `[itemprop="item-precipitation"]`, property: `weather.precipitation` },
      { selector: `[itemprop="item-pressure"]`, property: `weather.pressure` },
    ];

    this.boolMapping = [
      /** circumstances */
      { selector: `[itemprop="item-amenity"]`, property: `accidentCircumstance.amenity` },
      { selector: `[itemprop="item-bump"]`, property: `accidentCircumstance.bump` },
      {
        selector: `[itemprop="item-crossing"]`,
        property: `accidentCircumstance.crossing`,
      },
      {
        selector: `[itemprop="item-giveAway"]`,
        property: `accidentCircumstance.giveAway`,
      },
      {
        selector: `[itemprop="item-Junction"]`,
        property: `accidentCircumstance.junction`,
      },
      { selector: `[itemprop="item-No_Exit"]`, property: `accidentCircumstance.noExit` },
      { selector: `[itemprop="item-Railway"]`, property: `accidentCircumstance.railWay` },
      {
        selector: `[itemprop="item-Roundabout"]`,
        property: `accidentCircumstance.roundAbout`,
      },
      { selector: `[itemprop="item-Station"]`, property: `accidentCircumstance.station` },
      { selector: `[itemprop="item-Stop"]`, property: `accidentCircumstance.stop` },
      {
        selector: `[itemprop="item-Traffic_Calming"]`,
        property: `accidentCircumstance.trafficCalming`,
      },
      {
        selector: `[itemprop="item-Traffic_Signal"]`,
        property: `accidentCircumstance.trafficSignal`,
      },
      {
        selector: `[itemprop="item-Turning_Loop"]`,
        property: `accidentCircumstance.trafficLoop`,
      },
    ];

    this.render = () => {
     
      this.containerNode.style.display = ``;

      this.mapping.forEach(({ selector, property }) => {
        this.containerNode.querySelector(selector).innerHTML = objPath(
          this.subject,
          property
        );
      });

      this.boolMapping.forEach(({ selector, property }) => {
        const node = this.containerNode.querySelector(selector);
        const value = objPath(this.subject, property);

        if (value) {
          node.style.display = "";
        } else {
          node.style.display = "none";
        }
      });
    };

    this.unMount = () => {
      this.containerNode.style.display = "none";
    };
  }
}

class Pagination {
  constructor(props) {
    this.selectors = {
      containerSelector: `[itemprop="pagination-content"]`,
      containerInnerSelector: `[itemprop="pagination-inner"]`,
      btnPrevSelector: `[itemprop="pagination-prev"]`,
      btnNextSelector: `[itemprop="pagination-next"]`,
      paginationNumberSelector: `[itemprop="pagination-number"]`,
      perPageSelector: `[itemprop="result-per-page"]`,
    };

    this.containerNode = props.parentNode.querySelector(
      this.selectors.containerSelector
    );
    this.containerInnerNode = this.containerNode.querySelector(
      this.selectors.containerInnerSelector
    );
    this.btnPrevNode = this.containerNode.querySelector(
      this.selectors.btnPrevSelector
    );
    this.btnNextNode = this.containerNode.querySelector(
      this.selectors.btnNextSelector
    );
    this.pageNodes = this.containerNode.querySelectorAll(
      this.selectors.paginationNumberSelector
    );
    this.perPageSelectNode = this.containerNode.querySelector(
      this.selectors.perPageSelector
    );

    this.page = 1;
    this.pageStart = 1;
    this.sectionIndex = 1;

    this.pageEnd = 1;
    this.showPrev = false;
    this.showNext = false;

    this.perPage = 20;

    this.setPage = (page) => {
      this.page = page;
      props.fetchListCallback();
    };

    /**
     * disable things while the list is loading
     * @param {boolean} value
     */
    this.setListFetching = (value) => {
      for (let i = 0; i < this.pageNodes.length; i++) {
        this.pageNodes[i].disabled = Boolean(value);
      }

      this.btnNextNode.disabled = Boolean(value);
      this.btnPrevNode.disabled = Boolean(value);
      this.perPageSelectNode.disabled = Boolean(value);
    };

    for (let i = 0; i < this.pageNodes.length; i++) {
      const node = this.pageNodes[i];
      node.addEventListener("click", () => {
        /** preselect for visuals */
        for (
          let nodeIndex = this.pageStart;
          nodeIndex < this.pageNodes.length;
          nodeIndex++
        ) {
          if (nodeIndex === i) {
            this.pageNodes[nodeIndex].classList.add("selected-page");
          } else {
            this.pageNodes[nodeIndex].classList.remove("selected-page");
          }
        }

        this.setPage(node.value);
      });
    }

    this.render = () => {
      /** select the current page and display the correct buttons */
      let nodeIndex = 0;
      for (let i = this.pageStart; i <= this.pageEnd; i++) {
        this.pageNodes[nodeIndex].style.display = "";
        this.pageNodes[nodeIndex].setAttribute("value", i);
        this.pageNodes[nodeIndex].innerHTML = i;

        if (i === this.page) {
          this.pageNodes[nodeIndex].classList.add("selected-page");
        } else {
          this.pageNodes[nodeIndex].classList.remove("selected-page");
        }

        nodeIndex++;
      }
      for (let i = nodeIndex; i < this.pageNodes.length; i++) {
        this.pageNodes[i].style.display = "none";
      }

      /** handle arrow buttons */
      if (this.showNext) {
        this.btnNextNode.style.visibility = "";
      } else {
        this.btnNextNode.style.visibility = "none";
      }
      if (this.showPrev) {
        this.btnPrevNode.style.visibility = "";
      } else {
        this.btnPrevNode.style.visibility = "none";
      }

      this.perPageSelectNode.value = this.perPage;
    };

    this.onResultResponse = (data) => {
      this.page = data.page;

      for (let i = 10; i <= Math.ceil(data.pageMax / 10) * 10; i += 10) {
        if (this.page > i - 10 && this.page <= i) {
          this.pageStart = i - 10 + 1;
          if (this.pageEnd > data.pageMax) {
            this.pageEnd = data.pageMax;
          } else {
            this.pageEnd = i;
          }
          break;
        }
      }

      this.showPrev = this.pageStart > 10;
      this.showNext = this.pageEnd < data.pageMax;
      this.perPage = data.perPage;

      this.render();
    };

    this.btnPrevNode.addEventListener("click", () => {
      this.setPage(this.page - 1);
    });
    this.btnNextNode.addEventListener("click", () => {
      this.setPage(this.page + 1);
    });

    this.perPageSelectNode.addEventListener("change", () => {
      this.perPage = Number(this.perPageSelectNode.value) || 20;
      props.fetchListCallback();
    });

    /**
     * reset without render - meant to be called once a filter has been changed
     */
    this.reset = () => {
      this.page = 1;
      this.pageStart = 1;
      this.sectionIndex = 1;

      this.pageEnd = 1;
      this.showPrev = false;
      this.showNext = false;
    };
  }
}

class SearchContent {
  constructor(props) {
    this.searchInstance = props.searchInstance;

    /**
     * @var {SearchResult[]}
     */
    this.resultItems = [];

    this.selectors = {
      listContainerSelector: "#list-results",
      listContainerItemsSelector: `[itemprop="list-container"]`,
      listItemSelector: `[itemprop="list-item"]`,
      listLoaderSelector: `[itemprop="list-loader"]`,
      emptyIndicatorSelector: `[itemprop="empty-indicator"]`,
      sortSelector: "#sort-select",
      sortDir: "#sort-dir-check" //checkbox
    };

    /** define relevant nodes */
    this.containerNode = document.querySelector(
      this.selectors.listContainerSelector
    );
    this.nodes = this.containerNode.querySelectorAll(
      this.selectors.listItemSelector
    );
    this.listLoaderNode = this.containerNode.querySelector(
      this.selectors.listLoaderSelector
    );
    this.listContainerItemsNode = this.containerNode.querySelector(
      this.selectors.listContainerItemsSelector
    );
    this.sortSelectorNode = document.querySelector(this.selectors.sortSelector);
    this.sortDirInputNode = document.querySelector(this.selectors.sortDir);

    /** instantiate pagination */
    this.paginationInstance = new Pagination({
      fetchListCallback: () => {
        this.fetchList(props.getFilters()).then(() => {
          window.scrollTo(0, document.body.clientHeight);
        });
      },
      parentNode: this.containerNode,
    });

    this.setEmptyIndicatorVisible = (value) => {
      this.listContainerItemsNode.classList.add(
        "more-than-one-result-" + String(Boolean(value))
      );
      this.listContainerItemsNode.classList.remove(
        "more-than-one-result-" + String(!Boolean(value))
      );
    };

    this.setItems = (subjects) => {
      this.setEmptyIndicatorVisible(subjects.length > 0);

      for (
        let i = 0;
        i < this.resultItems.length && i < this.nodes.length;
        i++
      ) {
        this.resultItems[i].unMount();
        this.resultItems[i] = null;
      }

      this.resultItems = [];
      for (let i = 0; i < subjects.length; i++) {
        const item = new SearchResult({
          subject: subjects[i],
          containerNode: this.nodes[i],
        });
        item.render();
        this.resultItems.push(item);
      }
    };

    this.fetchKey = null;
    this.isFetching = false;

    this.setIsFetching = (value) => {

      

      if (value !== this.isFetching) {
        this.searchInstance.listIsFetching(value);

        if (value) {
          this.listLoaderNode.style.display = "";
          this.listContainerItemsNode.style.display = "none";
          this.sortSelectorNode.disabled = true;
        } else {
          this.listLoaderNode.style.display = "none";
          this.listContainerItemsNode.style.display = "";
          this.sortSelectorNode.disabled = false;
        }

        this.isFetching = value;
      }
    };

    this.getSortValue = () => {
      if (this.sortSelectorNode.value === "default") {
        return "";
      }
      return encodeURIComponent(this.sortSelectorNode.value);
    };

    /**
     *
     * @param {Filter[]} filters
     */
    this.fetchList = (filters) => {
      const callKey = Date.now();
      this.fetchKey = callKey;

      this.setIsFetching(true);

      this.lastSearchValue = this.searchInstance.getValue();
      this.paginationInstance.setListFetching(true);

      return fetch(
        `${window.BASE_URL}search/results?search=${encodeURIComponent(
          this.lastSearchValue
        )}&sortBy=${this.getSortValue()}&dir=${this.sortDirInputNode.checked ? "1" : "0"}&page=${
          this.paginationInstance.page
        }&perPage=${this.paginationInstance.perPage}`,
        {
          headers: new Headers(),
          method: "POST",
          body: JSON.stringify({
            filters: filters.map(
              /**
               *
               * @param {Filter} item
               * @returns
               */
              (item) => ({
                filterKey: item.filterKey,
                availableOptions: item.availableOptions,
              })
            ),
          }),
        }
      )
        .then((response) => {
          if (response.ok) {
            return response.json();
          }
          throw response;
        })
        .then((data) => {
          if (this.fetchKey === callKey) {
            this.setItems(data.results);
            mapPreviewInstance.setLayers(
              data.results.reduce((prev, cur, index) => {
                return {
                  ...prev,
                  [`layerName-${Date.now()}-${index}`]: {
                    img: (() => {
                      return (
                        {
                          1: "red-dot-shade-1.svg",
                          2: "red-dot-shade-2.svg",
                          3: "red-dot-shade-3.svg",
                          4: "red-dot-shade-4.svg",
                        }[cur.severity] || "red-dot-shade-1.svg"
                      );
                    })(),
                    ...cur,
                  },
                };
              }, {})
            );
            mapPreviewInstance.render();

            this.paginationInstance.onResultResponse(data);
            this.paginationInstance.setListFetching(false);
          }
        })
        .catch((response) => {
          console.log("BAD REQUEST", response);
          this.paginationInstance.setListFetching(false);
        })
        .finally(() => {
          if (callKey === this.fetchKey) {
            this.setIsFetching(false);
          }
          return new Promise((resolve) => resolve());
        });
    };
  }
}

/**
 * @typedef {Object} IFilter
 * @property {Array} availableOptions
 * @property {String} filterKey
 * @property {String} title
 * @property {String} selectionType
 */
class SearchPage {
  constructor() {
    this.selectors = {
      FILTER_TOGGLE: `#search-results [itemprop="filter-btn"]`,
      parentNode: `#filter-edit-c`,
      containerNode: `[itemprop="filters-append"]`,
      cancelBtnSelector: `[itemprop="btn-bottom-panel"] [itemprop="btn-cancel"]`,
      confirmBtnSelector: `[itemprop="btn-bottom-panel"] [itemprop="btn-confirm"]`,
      mapPreviewSelector: `#map-btn-preview`
    };

    /** initialize nodes */
    this.parentNode = document.querySelector(this.selectors.parentNode);
    this.containerNode = this.parentNode.querySelector(
      this.selectors.containerNode
    );
    this.cofirmButtonNode = this.parentNode.querySelector(
      this.selectors.confirmBtnSelector
    );
    this.cancelButtonNode = this.parentNode.querySelector(
      this.selectors.cancelBtnSelector
    );


    /** create an instance responsable with input handling and filter toggle */
    this.searchInstance = new SearchInput({
      filterContainerNode: this.parentNode,
    });

    /** instance responsable with populating the list */
    this.searchContentInstance = new SearchContent({
      searchInstance: this.searchInstance,
      getFilters: () => {
        return this.filters;
      },
    });

    this.searchInstance.fetchListCallback = () => {
      this.searchContentInstance.paginationInstance.reset();
      this.searchContentInstance.fetchList(this.filters);
    };

    /** fetch and initialize filter instances */
    this.filters = [];
    this.filtersInitialPayload = [];

    this.filterTypes = {
      DATE_RANGE: "date_range",
      CHECKBOX_LIST: "checkbox-list",
      CHECKBOX_BUTTON_LIST: "checkbox-button-list",
      NUMERIC_RANGE: "numeric_range",
      LOCATION: "location",
    };

    /**
     * fetches filter json from api and instanciate objects and nodes, then fetch the list based on those filter objects created
     */
    this.initFilters = () => {
      this.setFiltersFetching(true);

      fetch(`${window.BASE_URL}search/filters`, {
        headers: new Headers(),
        method: "GET",
      })
        .then((response) => {
          if (response.ok) {
            return response.json();
          }
          throw response;
        })
        .then((json) => {
          
          this.containerNode.innerHTML = "";

          json.forEach(
            /**
             *
             * @param {IFilter} filterApi
             */
            (filterApi) => {
              const appendObj = {
                parentNode: this.containerNode,
              };
              let filter = null;
              const payload = {
                ...filterApi,
                ...appendObj,
              };

              switch (filterApi.selectionType) {
                case this.filterTypes.DATE_RANGE:
                  filter = new DateFilter(payload);
                  break;

                case this.filterTypes.CHECKBOX_LIST:
                  filter = new FilterCheckBox(payload);
                  break;

                case this.filterTypes.CHECKBOX_BUTTON_LIST:
                  filter = new FilterGenericExpandable(payload);
                  break;

                case this.filterTypes.NUMERIC_RANGE:
                  filter = new FilterRange(payload);
                  break;

                case this.filterTypes.LOCATION:
                  filter = new LocationFilter(payload);
                  break;
              }

              if (filter) {
                this.filters.push(filter);
                filter.render();
              }

              this.searchContentInstance.filters = this.filters;
            }
          );
        })
        .catch((response) => {
          console.log("BAD REQUEST", response);
        })
        .finally(() => {
          this.setFiltersFetching(false);
          
        });
    };

    this.setFiltersFetching = (value) => {
      this.searchInstance.setFiltersFetching(value);
    };

    this.initBottomPanel = () => {
      /** APPLY FILTER BUTTON */
      this.cofirmButtonNode.addEventListener("click", (event) => {
        this.filters.forEach((item) => {
          item.saveState();
        });

        this.searchInstance.setFilterActive(false);
        this.searchContentInstance.paginationInstance.reset();
        this.searchContentInstance.fetchList(this.filters);
      });

      /** CANCEL FILTER BUTTON */
      this.cancelButtonNode.addEventListener("click", (event) => {
        this.searchInstance.setFilterActive(false);
        this.filters.forEach((filterItem) => {
          filterItem.restoreToPrevious();
        });
      });
    };

    this.initFilters();
    this.initBottomPanel();
    this.searchContentInstance.fetchList(this.filters);

    /** SORT SELECT EVENT LISTENER */
    this.searchContentInstance.sortSelectorNode.addEventListener(
      "change",
      () => {
        this.searchContentInstance.paginationInstance.reset();
        this.searchContentInstance.fetchList(this.filters);
      }
    );

    /** CLEAR INPUT EVENT LISTENER */
    this.searchInstance.clearInputNode.addEventListener("click", (event) => {
      if (this.searchInstance.searchInputNode.value) {
        this.searchInstance.searchInputNode.value = "";

        if (this.searchContentInstance.lastSearchValue !== "") {
          this.searchContentInstance.paginationInstance.reset();
          this.searchContentInstance.fetchList(this.filters);
        } else {
          this.searchInstance.searchInputNode.focus();
        }
      }
    });

    document
      .querySelector(this.selectors.mapPreviewSelector)
      .addEventListener("click", () => {
        mapPreviewInstance.showModal();
      });

    /** export button event listener - export current results from the page*/
    this.exportBtnNode = this.searchInstance.exportBtnNode;
    this.exportBtnNode.addEventListener("click", () => {
      const link = `${window.BASE_URL}search/export?ids=${encodeURIComponent(
        this.searchContentInstance.resultItems.reduce((prev, cur) => {
          const id = cur.subject.uniqueId;
          if (prev) {
            return `${prev}, ${id}`;
          }
          return id;
        }, "")
      )}&limit=${this.searchContentInstance.paginationInstance.perPage}`;
      window.open(link, "_blank");
    });
  }
}

(() => {
  const eventHandler = () => {
    window.searchPageInstance = new SearchPage();
  };
  if (document.readyState !== "loading") {
    eventHandler();
  } else {
    document.addEventListener("DOMContentLoaded", eventHandler);
  }
})();
